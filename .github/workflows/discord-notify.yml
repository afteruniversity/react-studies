name: "Notificar no Discord - Back-End"

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, reopened, closed]
    branches: [main]
  issues:
    types: [opened, edited, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Verificar se o webhook est√° configurado
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "‚ö†Ô∏è DISCORD_WEBHOOK n√£o est√° configurado."
            exit 1
          fi

      # Notifica√ß√£o para PUSH
      - name: Notificar Push no Discord
        if: github.event_name == 'push'
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          curl -H "Content-Type: application/json" -X POST -d '{
            "embeds": [{
              "title": "üì¶ Novo Push para main",
              "url": "${{ github.event.compare }}",
              "description": "[${{ github.repository }}]\n\n**Commit**: [`${SHORT_SHA}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) - `${COMMIT_MSG}`",
              "color": 3447003,
              "author": {
                "name": "${{ github.actor }}"
              },
              "footer": {
                "text": "Push em '"$(TZ=America/Sao_Paulo date "+%d/%m/%Y √†s %H:%M")"'"
              }
            }]
          }' "${{ secrets.DISCORD_WEBHOOK }}"

      # Notifica√ß√£o para PULL REQUEST
      - name: Notificar Pull Request no Discord
        if: github.event_name == 'pull_request'
        run: |
          ACTION="${{ github.event.action }}"
          TITLE=$(echo "${{ github.event.pull_request.title }}" | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          
          if [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            ACTION="merged"
            COLOR=10181046
            STATUS="‚úÖ PR Merged"
          elif [[ "${{ github.event.action }}" == "closed" ]]; then
            ACTION="closed"
            COLOR=15158332
            STATUS="‚ùå PR Fechado"
          else
            COLOR=3447003
            STATUS="üöÄ PR Aberto/Reaberto"
          fi

          curl -H "Content-Type: application/json" -X POST -d "{
            \"embeds\": [{
              \"title\": \"${STATUS}: #${{ github.event.pull_request.number }}\",
              \"url\": \"${{ github.event.pull_request.html_url }}\",
              \"description\": \"[${{ github.repository }}]\n\n**T√≠tulo**: ${TITLE}\",
              \"color\": ${COLOR},
              \"author\": {
                \"name\": \"${{ github.actor }}\"
              },
              \"footer\": {
                \"text\": \"Pull Request ${ACTION} em '"$(TZ=America/Sao_Paulo date "+%d/%m/%Y √†s %H:%M")"'"
              }
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"
      
      # Notifica√ß√£o para ISSUE
      - name: Notificar Issue no Discord
        if: github.event_name == 'issues'
        run: |
          TITLE=$(echo "${{ github.event.issue.title }}" | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          ACTION="${{ github.event.action }}"
          
          if [[ "$ACTION" == "opened" ]]; then
            COLOR=3447003
            STATUS="üêû Nova Issue"
          elif [[ "$ACTION" == "closed" ]]; then
            COLOR=10181046
            STATUS="‚úîÔ∏è Issue Fechada"
          else
            COLOR=16776960
            STATUS="üìù Issue Editada"
          fi
          
          curl -H "Content-Type: application/json" -X POST -d "{
            \"embeds\": [{
              \"title\": \"${STATUS}: #${{ github.event.issue.number }}\",
              \"url\": \"${{ github.event.issue.html_url }}\",
              \"description\": \"[${{ github.repository }}]\n\n**T√≠tulo**: ${TITLE}\",
              \"color\": ${COLOR},
              \"author\": {
                \"name\": \"${{ github.actor }}\"
              },
              \"footer\": {
                \"text\": \"Issue ${ACTION} em '"$(TZ=America/Sao_Paulo date "+%d/%m/%Y √†s %H:%M")"'"
              }
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"